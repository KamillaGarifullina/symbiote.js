class t{constructor(t){this.uid=Symbol(),this.name=t.name||null,t.schema.constructor===Object?this.store=function(t){let e=t=>{for(let s in t)t[s]?.constructor===Object&&(t[s]=e(t[s]));return{...t}};return e(t)}(t.schema):(this._storeIsProxy=!0,this.store=t.schema),this.callbackMap=Object.create(null)}static warn(t,e){console.warn(`Symbiote Data: cannot ${t}. Prop name: `+e)}read(e){return this._storeIsProxy||this.store.hasOwnProperty(e)?this.store[e]:(t.warn("read",e),null)}has(t){return this._storeIsProxy?void 0!==this.store[t]:this.store.hasOwnProperty(t)}add(t,e,s=!0){!s&&Object.keys(this.store).includes(t)||(this.store[t]=e,this.callbackMap[t]&&this.callbackMap[t].forEach((e=>{e(this.store[t])})))}pub(e,s){this._storeIsProxy||this.store.hasOwnProperty(e)?this.add(e,s):t.warn("publish",e)}multiPub(t){for(let e in t)this.pub(e,t[e])}notify(t){this.callbackMap[t]&&this.callbackMap[t].forEach((e=>{e(this.store[t])}))}sub(e,s,i=!0){return this._storeIsProxy||this.store.hasOwnProperty(e)?(this.callbackMap[e]||(this.callbackMap[e]=new Set),this.callbackMap[e].add(s),i&&s(this.store[e]),{remove:()=>{this.callbackMap[e].delete(s),this.callbackMap[e].size||delete this.callbackMap[e]},callback:s}):(t.warn("subscribe",e),null)}remove(){delete t.globalStore[this.uid]}static registerLocalCtx(e){let s=new t({schema:e});return t.globalStore[s.uid]=s,s}static registerNamedCtx(e,s){let i=t.globalStore[e];return i?console.warn('State: context name "'+e+'" already in use'):(i=new t({name:e,schema:s}),t.globalStore[e]=i),i}static clearNamedCtx(e){delete t.globalStore[e]}static getNamedCtx(e,s=!0){return t.globalStore[e]||(s&&console.warn('State: wrong context name - "'+e+'"'),null)}}t.globalStore=Object.create(null);const e=Object.freeze({BIND_ATTR:"set",ATTR_BIND_PRFX:"@",EXT_DATA_CTX_PRFX:"*",NAMED_DATA_CTX_SPLTR:"/",CTX_NAME_ATTR:"ctx-name",CSS_CTX_PROP:"--ctx-name",EL_REF_ATTR:"ref",AUTO_TAG_PRFX:"sym"}),s="1234567890QWERTYUIOPASDFGHJKLZXCVBNMqwertyuiopasdfghjklzxcvbnm",i=s.length-1;class r{static generate(t="XXXXXXXXX-XXX"){let e="";for(let r=0;r<t.length;r++)e+="-"===t[r]?t[r]:s.charAt(Math.random()*i);return e}}var a=[function(t,e){if(e.renderShadow)return;let s=[...t.querySelectorAll("slot")];if(e.__initChildren.length&&s.length){let t={};s.forEach((e=>{let s=e.getAttribute("name");s?t[s]={slot:e,fr:document.createDocumentFragment()}:t.__default__={slot:e,fr:document.createDocumentFragment()}})),e.__initChildren.forEach((e=>{let s=e.getAttribute?.("slot");s?(e.removeAttribute("slot"),t[s].fr.appendChild(e)):t.__default__&&t.__default__.fr.appendChild(e)})),Object.values(t).forEach((t=>{t.slot.parentNode.insertBefore(t.fr,t.slot),t.slot.remove()}))}else e.innerHTML=""},function(t,s){[...t.querySelectorAll(`[${e.EL_REF_ATTR}]`)].forEach((t=>{let i=t.getAttribute(e.EL_REF_ATTR);s.ref[i]=t,t.removeAttribute(e.EL_REF_ATTR)}))},function(t,s){[...t.querySelectorAll(`[${e.BIND_ATTR}]`)].forEach((t=>{t.getAttribute(e.BIND_ATTR).split(";").forEach((i=>{if(!i)return;let r,a=i.split(":").map((t=>t.trim())),o=a[0];0===o.indexOf(e.ATTR_BIND_PRFX)&&(r=!0,o=o.replace(e.ATTR_BIND_PRFX,""));let n,l,h,c,_=a[1].split(",").map((t=>t.trim()));if(o.includes(".")){n=!0;let e=o.split(".");c=()=>{l=t,e.forEach(((t,s)=>{s<e.length-1?l=l[t]:h=t}))},c()}for(let e of _)s.sub(e,(e=>{r?e?.constructor===Boolean?e?t.setAttribute(o,""):t.removeAttribute(o):t.setAttribute(o,e):n?l?l[h]=e:window.setTimeout((()=>{c(),l[h]=e})):t[o]=e}))})),t.removeAttribute(e.BIND_ATTR)}))}];let o=0;class n extends HTMLElement{render(t,e=this.renderShadow){let s;if(t||this.constructor.template){for(this.constructor.template&&!this.constructor.__tpl&&(this.constructor.__tpl=document.createElement("template"),this.constructor.__tpl.innerHTML=this.constructor.template);this.firstChild;)this.firstChild.remove();if(t?.constructor===DocumentFragment)s=t;else if(t?.constructor===String){let e=document.createElement("template");e.innerHTML=t,s=e.content.cloneNode(!0)}else this.constructor.__tpl&&(s=this.constructor.__tpl.content.cloneNode(!0));for(let t of this.tplProcessors)t(s,this)}e?(this.shadowRoot||this.attachShadow({mode:"open"}),s&&this.shadowRoot.appendChild(s)):s&&this.appendChild(s)}addTemplateProcessor(t){this.tplProcessors.add(t)}constructor(){super(),this.init$=Object.create(null),this.tplProcessors=new Set,this.ref=Object.create(null),this.allSubs=new Set,this.pauseRender=!1,this.renderShadow=!1,this.readyToDestroy=!0}get autoCtxName(){return this.__autoCtxName||(this.__autoCtxName=r.generate(),this.style.setProperty(e.CSS_CTX_PROP,`'${this.__autoCtxName}'`)),this.__autoCtxName}get cssCtxName(){return this.getCssData(e.CSS_CTX_PROP,!0)}get ctxName(){return this.getAttribute(e.CTX_NAME_ATTR)?.trim()||this.cssCtxName||this.autoCtxName}get localCtx(){return this.__localCtx||(this.__localCtx=t.registerLocalCtx({})),this.__localCtx}get nodeCtx(){return t.getNamedCtx(this.ctxName,!1)||t.registerNamedCtx(this.ctxName,{})}static __parseProp(s,i){let r,a;if(s.startsWith(e.EXT_DATA_CTX_PRFX))r=i.nodeCtx,a=s.replace(e.EXT_DATA_CTX_PRFX,"");else if(s.includes(e.NAMED_DATA_CTX_SPLTR)){let i=s.split(e.NAMED_DATA_CTX_SPLTR);r=t.getNamedCtx(i[0]),a=i[1]}else r=i.localCtx,a=s;return{ctx:r,name:a}}sub(t,e){let s=n.__parseProp(t,this);this.allSubs.add(s.ctx.sub(s.name,e))}notify(t){let e=n.__parseProp(t,this);e.ctx.notify(e.name)}has(t){let e=n.__parseProp(t,this);return e.ctx.has(e.name)}add(t,e){let s=n.__parseProp(t,this);s.ctx.add(s.name,e,!1)}add$(t){for(let e in t)this.add(e,t[e])}get $(){if(!this.__stateProxy){let t=Object.create(null);this.__stateProxy=new Proxy(t,{set:(t,e,s)=>{let i=n.__parseProp(e,this);return i.ctx.pub(i.name,s),!0},get:(t,e)=>{let s=n.__parseProp(e,this);return s.ctx.read(s.name)}})}return this.__stateProxy}set$(t){for(let e in t)this.$[e]=t[e]}initCallback(){}__initDataCtx(){let s=this.constructor.__attrDesc;if(s)for(let t of Object.values(s))Object.keys(this.init$).includes(t)||(this.init$[t]="");for(let s in this.init$)if(s.startsWith(e.EXT_DATA_CTX_PRFX))this.nodeCtx.add(s.replace(e.EXT_DATA_CTX_PRFX,""),this.init$[s]);else if(s.includes(e.NAMED_DATA_CTX_SPLTR)){let i=s.split(e.NAMED_DATA_CTX_SPLTR),r=i[0].trim(),a=i[1].trim();if(r&&a){let e=t.getNamedCtx(r,!1);e||(e=t.registerNamedCtx(r,{})),e.add(a,this.init$[s])}}else this.localCtx.add(s,this.init$[s]);this.__dataCtxInitialized=!0}connectedCallback(){if(this.__disconnectTimeout&&window.clearTimeout(this.__disconnectTimeout),!this.connectedOnce){let t=this.getAttribute(e.CTX_NAME_ATTR)?.trim();t&&this.style.setProperty(e.CSS_CTX_PROP,`'${t}'`),this.__initDataCtx(),this.__initChildren=[...this.childNodes];for(let t of a)this.addTemplateProcessor(t);this.pauseRender||this.render(),this.initCallback?.()}this.connectedOnce=!0}destroyCallback(){}disconnectedCallback(){this.dropCssDataCache(),this.readyToDestroy&&(this.__disconnectTimeout&&window.clearTimeout(this.__disconnectTimeout),this.__disconnectTimeout=window.setTimeout((()=>{this.destroyCallback();for(let t of this.allSubs)t.remove(),this.allSubs.delete(t);for(let t of this.tplProcessors)this.tplProcessors.delete(t)}),100))}static reg(t,s=!1){t||(o++,t=`${e.AUTO_TAG_PRFX}-${o}`),this.__tag=t,window.customElements.get(t)?console.warn(`${t} - is already in "customElements" registry`):window.customElements.define(t,s?class extends(this){}:this)}static get is(){return this.__tag||this.reg(),this.__tag}static bindAttributes(t){this.observedAttributes=Object.keys(t),this.__attrDesc=t}attributeChangedCallback(t,e,s){if(e===s)return;let i=this.constructor.__attrDesc[t];i?this.__dataCtxInitialized?this.$[i]=s:this.init$[i]=s:this[t]=s}getCssData(t,e=!1){if(this.__cssDataCache||(this.__cssDataCache=Object.create(null)),!Object.keys(this.__cssDataCache).includes(t)){this.__computedStyle||(this.__computedStyle=window.getComputedStyle(this));let s=this.__computedStyle.getPropertyValue(t).trim();s.startsWith("'")&&s.endsWith("'")&&(s=s.replace(/\'/g,'"'));try{this.__cssDataCache[t]=JSON.parse(s)}catch(s){!e&&console.warn(`CSS Data error: ${t}`),this.__cssDataCache[t]=null}}return this.__cssDataCache[t]}dropCssDataCache(){this.__cssDataCache=null,this.__computedStyle=null}defineAccessor(t,e,s){let i="__"+t;this[i]=this[t],Object.defineProperty(this,t,{set:t=>{this[i]=t,s?window.setTimeout((()=>{e?.(t)})):e?.(t)},get:()=>this[i]}),this[t]=this[i]}}const l="[Typed State] Wrong property name: ";class h{constructor(e,s){this.__typedSchema=e,this.__ctxId=s||r.generate(),this.__schema=Object.keys(e).reduce(((t,s)=>(t[s]=e[s].value,t)),{}),this.__state=t.registerNamedCtx(this.__ctxId,this.__schema)}setValue(t,e){this.__typedSchema.hasOwnProperty(t)?e?.constructor===this.__typedSchema[t].type?this.__state.pub(t,e):console.warn("[Typed State] Wrong property type: "+t):console.warn(l+t)}setMultipleValues(t){for(let e in t)this.setValue(e,t[e])}getValue(t){if(this.__typedSchema.hasOwnProperty(t))return this.__state.read(t);console.warn(l+t)}subscribe(t,e){return this.__state.sub(t,e)}remove(){this.__state.remove()}}class c{constructor(e){this.__typedSchema=e.typedSchema,this.__ctxId=e.ctxName||r.generate(),this.__state=t.registerNamedCtx(this.__ctxId,{}),this.__watchList=e.watchList||[],this.__handler=e.handler||null,this.__subsMap=Object.create(null),this.__observers=new Set,this.__items=new Set;let s=Object.create(null);this.__notifyObservers=(t,e)=>{this.__observeTimeout&&window.clearTimeout(this.__observeTimeout),s[t]||(s[t]=new Set),s[t].add(e),this.__observeTimeout=window.setTimeout((()=>{this.__observers.forEach((t=>{t({...s})})),s=Object.create(null)}))}}notify(){this.__notifyTimeout&&window.clearTimeout(this.__notifyTimeout),this.__notifyTimeout=window.setTimeout((()=>{this.__handler?.([...this.__items])}))}add(t){let e=new h(this.__typedSchema);for(let s in t)e.setValue(s,t[s]);return this.__state.add(e.__ctxId,e),this.__watchList.forEach((t=>{this.__subsMap[e.__ctxId]||(this.__subsMap[e.__ctxId]=[]),this.__subsMap[e.__ctxId].push(e.subscribe(t,(()=>{this.__notifyObservers(t,e.__ctxId)})))})),this.__items.add(e.__ctxId),this.notify(),e}read(t){return this.__state.read(t)}readProp(t,e){return this.read(t).getValue(e)}publishProp(t,e,s){this.read(t).setValue(e,s)}remove(t){this.__items.delete(t),this.notify(),this.__state.pub(t,null),delete this.__subsMap[t]}clearAll(){this.__items.forEach((t=>{this.remove(t)}))}observe(t){this.__observers.add(t)}unobserve(t){this.__observers.delete(t)}findItems(t){let e=[];return this.__items.forEach((s=>{let i=this.read(s);t(i)&&e.push(s)})),e}items(){return[...this.__items]}destroy(){this.__state.remove(),this.__observers=null;for(let t in this.__subsMap)this.__subsMap[t].forEach((t=>{t.remove()})),delete this.__subsMap[t]}}class _{static _print(t){console.warn(t)}static setDefaultTitle(t){this.defaultTitle=t}static setRoutingMap(t){Object.assign(this.appMap,t);for(let t in this.appMap)this.defaultRoute||!0!==this.appMap[t].default?this.errorRoute||!0!==this.appMap[t].error||(this.errorRoute=t):this.defaultRoute=t}static set routingEventName(t){this.__routingEventName=t}static get routingEventName(){return this.__routingEventName||"sym-on-route"}static readAddressBar(){let t={route:null,options:{}};return window.location.search.split(this.separator).forEach((e=>{if(e.includes("?"))t.route=e.replace("?","");else if(e.includes("=")){let s=e.split("=");t.options[s[0]]=decodeURI(s[1])}else t.options[e]=!0})),t}static notify(){let t=this.readAddressBar(),e=this.appMap[t.route];if(e&&e.title&&(document.title=e.title),null===t.route&&this.defaultRoute)return void this.applyRoute(this.defaultRoute);if(!e&&this.errorRoute)return void this.applyRoute(this.errorRoute);if(!e&&this.defaultRoute)return void this.applyRoute(this.defaultRoute);if(!e)return void this._print(`Route "${t.route}" not found...`);let s=new CustomEvent(_.routingEventName,{detail:{route:t.route,options:Object.assign(e||{},t.options)}});window.dispatchEvent(s)}static reflect(t,e={}){let s=this.appMap[t];if(!s)return void this._print("Wrong route: "+t);let i="?"+t;for(let t in e)!0===e[t]?i+=this.separator+t:i+=this.separator+t+"="+`${e[t]}`;let r=s.title||this.defaultTitle||"";window.history.pushState(null,r,i),document.title=r}static applyRoute(t,e={}){this.reflect(t,e),this.notify()}static setSeparator(t){this._separator=t}static get separator(){return this._separator||"&"}static createRouterData(e,s){this.setRoutingMap(s);let i=t.registerNamedCtx(e,{route:null,options:null,title:null});return window.addEventListener(this.routingEventName,(t=>{i.multiPub({route:t.detail.route,options:t.detail.options,title:t.detail.options?.title||this.defaultTitle||""})})),_.notify(),i}}function u(t,e){for(let s in e)s.includes("-")?t.style.setProperty(s,e[s]):t.style[s]=e[s]}function d(t,e){for(let s in e)e[s].constructor===Boolean?e[s]?t.setAttribute(s,""):t.removeAttribute(s):t.setAttribute(s,e[s])}function p(t={tag:"div"}){let e=document.createElement(t.tag);if(t.attributes&&d(e,t.attributes),t.styles&&u(e,t.styles),t.properties)for(let s in t.properties)e[s]=t.properties[s];return t.processors&&t.processors.forEach((t=>{t(e)})),t.children&&t.children.forEach((t=>{let s=p(t);e.appendChild(s)})),e}_.appMap=Object.create(null),window.onpopstate=()=>{_.notify()};class m{_notifyWhenReady(t=null){window.dispatchEvent(new CustomEvent("idb-store-ready",{detail:{dbName:this.name,storeName:this.storeName,event:t}}))}get _updEventName(){return"symbiote-idb-update_"+this.name}_getUpdateEvent(t){return new CustomEvent(this._updEventName,{detail:{key:this.name,newValue:t}})}_notifySubscribers(t){window.localStorage.removeItem(this.name),window.localStorage.setItem(this.name,t),window.dispatchEvent(this._getUpdateEvent(t))}constructor(t,e){this.name=t,this.storeName=e,this.version=1,this.request=window.indexedDB.open(this.name,this.version),this.request.onupgradeneeded=t=>{this.db=t.target.result,this.objStore=this.db.createObjectStore(e,{keyPath:"_key"}),this.objStore.transaction.oncomplete=t=>{this._notifyWhenReady(t)}},this.request.onsuccess=t=>{this.db=t.target.result,this._notifyWhenReady(t)},this.request.onerror=t=>{console.error(t)},this._subscribtionsMap={},this._updateHandler=t=>{if(t.key===this.name&&this._subscribtionsMap[t.newValue]){this._subscribtionsMap[t.newValue].forEach((async e=>{e(await this.read(t.newValue))}))}},this._localUpdateHandler=t=>{this._updateHandler(t.detail)},window.addEventListener("storage",this._updateHandler),window.addEventListener(this._updEventName,this._localUpdateHandler)}read(t){let e=this.db.transaction(this.storeName,"readwrite").objectStore(this.storeName).get(t);return new Promise(((s,i)=>{e.onsuccess=e=>{e.target.result?._value?s(e.target.result._value):(s(null),console.warn(`IDB: cannot read "${t}"`))},e.onerror=t=>{i(t)}}))}write(t,e,s=!1){let i={_key:t,_value:e},r=this.db.transaction(this.storeName,"readwrite").objectStore(this.storeName).put(i);return new Promise(((e,i)=>{r.onsuccess=i=>{s||this._notifySubscribers(t),e(i.target.result)},r.onerror=t=>{i(t)}}))}delete(t,e=!1){let s=this.db.transaction(this.storeName,"readwrite").objectStore(this.storeName).delete(t);return new Promise(((i,r)=>{s.onsuccess=s=>{e||this._notifySubscribers(t),i(s)},s.onerror=t=>{r(t)}}))}getAll(){let t=this.db.transaction(this.storeName,"readwrite").objectStore(this.storeName).getAll();return new Promise(((e,s)=>{t.onsuccess=t=>{let s=t.target.result;e(s.map((t=>t._value)))},t.onerror=t=>{s(t)}}))}subscribe(t,e){this._subscribtionsMap[t]||(this._subscribtionsMap[t]=new Set);let s=this._subscribtionsMap[t];return s.add(e),{remove:()=>{s.delete(e),s.size||delete this._subscribtionsMap[t]}}}stop(){window.removeEventListener("storage",this._updateHandler),this.__subscribtionsMap=null,b.clear(this.name)}}class b{static get readyEventName(){return"idb-store-ready"}static open(t="symbiote-db",e="store"){let s=`${t}/${e}`;return this._reg[s]||(this._reg[s]=new m(t,e)),this._reg[s]}static clear(t){window.indexedDB.deleteDatabase(t);for(let e in this._reg)e.split("/")[0]===t&&delete this._reg[e]}}b._reg=Object.create(null);export{_ as AppRouter,n as BaseComponent,t as Data,b as IDB,c as TypedCollection,h as TypedData,r as UID,d as applyAttributes,u as applyStyles,p as create};